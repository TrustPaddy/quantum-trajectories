<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Particles</title>
  <script src="aframe-v1.5.0.min.js"></script>
  <style>
    /* ─── Theme variables ─────────────────────────────────── */
    :root{
      color-scheme: dark;
      --bg: #0b0f17;
      --panel: #121826;
      --card: #0f1522;
      --acc: #7dd3fc;
      --txt: #e5e7eb;
      --muted:#94a3b8;
      --ok:  #22c55e;
      --warn:#f59e0b;
      --err: #ef4444;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --range-track: rgba(255,255,255,.15);
    }
    :root[data-theme="light"]{
      color-scheme: light;
      --bg: #f5f5f7;
      --panel: #ffffff;
      --card: #f3f4f6;
      --acc: #0ea5e9;
      --txt: #111827;
      --muted:#6b7280;
      --ok:  #16a34a;
      --warn:#d97706;
      --err: #b91c1c;
      --shadow: 0 10px 26px rgba(15,23,42,.18);
      --range-track: rgba(148,163,184,.6);
    }

    /* ─── Base ─────────────────────────────────────────────── */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
      font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    /* ─── Layout ───────────────────────────────────────────── */
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}

    .topbar{
      position:sticky;top:0;z-index:5;
      display:flex;align-items:center;gap:.75rem;
      padding:.6rem .9rem;
      background:var(--panel);
      backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid rgba(148,163,184,.3);
      flex-wrap:wrap;
    }
    .title{font-weight:700;letter-spacing:.2px}
    .spacer{flex:1}
    .group{display:inline-flex;align-items:center;gap:.5rem}

    .wrap{display:grid;grid-template-columns:minmax(260px,320px) 1fr;gap:14px;padding:14px}
    .panel{
      background:var(--panel);border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);padding:10px;box-shadow:var(--shadow);
      height:calc(100vh - 90px);overflow:auto;position:relative;z-index:3;
    }
    .scene{
      position:relative;z-index:1;overflow:hidden;
      background:radial-gradient(1200px 600px at 50% 10%,rgba(125,211,252,.08),transparent 60%),
                 linear-gradient(180deg,#0b0f17,#05070c);
      border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);
    }
    @media(max-width:1000px){.wrap{grid-template-columns:1fr}.panel{order:2}.scene{order:1}}

    /* ─── Buttons ──────────────────────────────────────────── */
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.12);
      background:var(--card);color:var(--txt);
      padding:.45rem .7rem;border-radius:10px;cursor:pointer;
      transition:.2s;display:inline-flex;align-items:center;gap:.5rem;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(180deg,#1f2937,#111827);border-color:#1f2a38}
    :root[data-theme="light"] .btn.primary{
      background:#f9fafb;border-color:rgba(148,163,184,.7);
      color:#111827;box-shadow:0 3px 8px rgba(15,23,42,.12);
    }
    :root[data-theme="light"] .btn.primary:hover{background:#fff}
    .btn.ghost{background:transparent}
    .btn.warn{border-color:rgba(245,158,11,.4)}
    .btn.ok{border-color:rgba(34,197,94,.4)}
    .btn.toggle[aria-pressed="true"],.btn.toggle.active{
      border-color:rgba(125,211,252,.7);box-shadow:var(--shadow)
    }

    /* ─── Range slider ─────────────────────────────────────── */
    .range{appearance:none;width:160px;height:6px;border-radius:999px;background:var(--range-track);outline:none}
    .range::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--acc);border:0;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    .range::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--acc);border:0;box-shadow:0 2px 6px rgba(0,0,0,.4)}

    /* ─── Select ───────────────────────────────────────────── */
    .select{background:var(--card);border:1px solid rgba(255,255,255,.12);color:var(--txt);padding:.45rem .6rem;border-radius:10px}

    /* ─── HUD ──────────────────────────────────────────────── */
    .hud{position:absolute;left:10px;right:10px;bottom:10px;display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.35rem .55rem;font-size:.9rem;color:var(--muted)}
    .chip strong{color:var(--txt);font-weight:700}
    .chip.ctr{display:inline-flex;align-items:center;gap:.4rem}
    .chip .mini{
      appearance:none;border:1px solid rgba(255,255,255,.18);
      background:transparent;color:var(--txt);
      padding:.05rem .45rem;border-radius:8px;line-height:1;cursor:pointer;
    }
    .chip .mini:hover{border-color:rgba(125,211,252,.55)}

    /* ─── Readout grid ─────────────────────────────────────── */
    .readout{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:6px}

    /* ─── Recording LED ────────────────────────────────────── */
    #led{width:10px;height:10px;border-radius:50%;background:#334155;display:inline-block;
      box-shadow:0 0 0 0 rgba(239,68,68,0);transition:box-shadow .3s,background .3s}
    #led.recording{background:var(--ok);box-shadow:0 0 0 6px rgba(34,197,94,.15)}

    /* ─── Hidden fields ────────────────────────────────────── */
    .hidden-field{display:inline-flex;gap:6px;align-items:center}
    .hidden-field input{width:70px;background:transparent;border:1px solid rgba(255,255,255,.12);
      border-radius:8px;color:var(--txt);padding:.2rem .35rem}

    /* ─── A-Frame fit ──────────────────────────────────────── */
    a-scene{height:calc(100vh - 90px);border-radius:var(--radius);position:relative!important;width:100%!important}
    .a-canvas,a-scene canvas{position:absolute;inset:0;width:100%!important;height:100%!important}

    /* ─── Quantum state label ──────────────────────────────── */
    .quantum-label{
      font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
      font-size:.85rem;color:var(--acc);margin-top:8px;padding:6px 8px;
      background:rgba(125,211,252,.06);border:1px solid rgba(125,211,252,.15);
      border-radius:8px;text-align:center;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- ═══ Topbar ═══ -->
    <div class="topbar">
      <span class="title">⚛︎ Simulation</span>
      <button id="myButton" class="btn primary" title="Start / Stop">Start</button>
      <button id="PathButton" class="btn" title="Pfad aufzeichnen">⏵</button>
      <span id="led" title="Animation läuft?"></span>
      <button id="btnDeletePath" class="btn warn" title="Pfad löschen">Pfad löschen</button>
      <button id="btnResetV" class="btn" title="Geschwindigkeiten = 0">v = 0</button>

      <button id="btnAnsatz"   class="btn toggle" aria-pressed="false" title="Angular Momentum Ansatz">Ang. Mom.</button>
      <button id="btnLarmor"   class="btn toggle" aria-pressed="false" title="Larmor-Strahlung">Larmor</button>
      <button id="btnThetaPhi" class="btn toggle" aria-pressed="false" title="θ/φ-Quantenterme">θ/φ</button>
      <button id="btnLock"     class="btn toggle" aria-pressed="false" title="Nucleus lock">Lock</button>
      <button id="btnRelax"    class="btn toggle" aria-pressed="false" title="Automatische Relaxation">Relax</button>

      <div class="group" style="margin-left:.4rem">
        <label for="dtSlider" style="opacity:.85">Δt</label>
        <input id="dtSlider" class="range" type="range" min="5" max="200" step="1" value="33" />
        <span id="dtValue" class="chip" style="padding:.2rem .45rem">33 ms</span>
      </div>

      <div class="spacer"></div>

      <label>Modell
        <select id="modelSelect" class="select">
          <option value="HAtom">H Atom</option>
          <option value="H2Cation">H₂⁺</option>
          <option value="HAnion">H⁻</option>
          <option value="HECation">He⁺</option>
          <option value="HEAtom">He</option>
        </select>
      </label>
      <button id="themeToggle" class="btn ghost" title="Hell/Dunkel umschalten">☾</button>
    </div>

    <!-- ═══ Main content ═══ -->
    <div class="wrap">

      <!-- ─── Control Panel ─── -->
      <aside class="panel">

        <!-- Quantum state display -->
        <div class="quantum-label" id="quantumStateLabel">|1, 0, 0⟩</div>

        <!-- Distance & Energy -->
        <div class="readout" style="margin-top:10px">
          <div class="chip">Abstand: <strong id="Distance">–</strong></div>
          <div class="chip">Energie: <strong id="Energy">–</strong></div>
        </div>

        <!-- Quantum numbers: n, ℓ, m -->
        <div class="readout">
          <div class="chip ctr">
            n:
            <button id="nDown" class="mini">−</button>
            <strong id="nLvl">1</strong>
            <button id="nUp" class="mini">+</button>
          </div>
          <div class="chip ctr">
            ℓ:
            <button id="lDown" class="mini">−</button>
            <strong id="lLvl">0</strong>
            <button id="lUp" class="mini">+</button>
          </div>
          <div class="chip ctr">
            m:
            <button id="mDown" class="mini">−</button>
            <strong id="mLvl">0</strong>
            <button id="mUp" class="mini">+</button>
          </div>
        </div>

        <!-- Particle counts -->
        <div class="readout">
          <div class="chip ctr">
            e⁻:
            <button id="eDown" class="mini">−</button>
            <strong id="DispCountElectron">1</strong>
            <button id="eUp" class="mini">+</button>
          </div>
          <div class="chip ctr">
            p⁺:
            <button id="pDown" class="mini">−</button>
            <strong id="DispCountProton">1</strong>
            <button id="pUp" class="mini">+</button>
          </div>
        </div>

        <!-- Force readout -->
        <div class="readout">
          <div class="chip">F<sub>x</sub>: <strong id="fx">0</strong></div>
          <div class="chip">F<sub>y</sub>: <strong id="fy">0</strong></div>
          <div class="chip">F<sub>z</sub>: <strong id="fz">0</strong></div>
        </div>

        <!-- Electron positions -->
        <div class="readout">
          <div class="chip">e₁ x: <strong id="posx1">–</strong></div>
          <div class="chip">e₁ y: <strong id="y1">–</strong></div>
          <div class="chip">e₁ z: <strong id="z1">–</strong></div>
          <div class="chip">e₂ x: <strong id="x2">–</strong></div>
          <div class="chip">e₂ y: <strong id="y2">–</strong></div>
          <div class="chip">e₂ z: <strong id="z2">–</strong></div>
        </div>

        <!-- Manual position input -->
        <div class="readout" style="margin-top:10px">
          <div class="hidden-field">x <input id="Xs" type="text" placeholder="x (pm)"></div>
          <div class="hidden-field">y <input id="Ys" type="text" placeholder="y (pm)"></div>
          <div class="hidden-field">z <input id="Zs" type="text" placeholder="z (pm)"></div>
        </div>
      </aside>

      <!-- ─── 3D Scene ─── -->
      <main class="scene">
        <a-scene embedded background="color: #111"
                 renderer="colorManagement: true; physicallyCorrectLights: true">
          <a-entity id="camera" position="0 0 200" camera look-controls></a-entity>
          <a-entity id="mouseCursor" cursor="rayOrigin: mouse"
                    raycaster="objects: .clickable; far: 1000; interval: 50"></a-entity>
          <a-entity light="type: ambient; color: #fff; intensity: 0.6"></a-entity>
          <a-entity light="type: directional; color: #fff; intensity: 0.8" position="0 1 1"></a-entity>
        </a-scene>

        <div class="hud">
          <div class="chip">Δt: <strong id="dtRead">33 ms</strong></div>
          <div class="chip">Ang. Mom.: <strong id="ansatzRead">aus</strong></div>
          <div class="chip">Larmor: <strong id="larmorRead">aus</strong></div>
          <div class="chip">Lock: <strong id="lockRead">aus</strong></div>
          <div class="chip">θ/φ: <strong id="thetaPhiRead">aus</strong></div>
          <div class="chip">Relax: <strong id="relaxRead">aus</strong></div>
        </div>
      </main>
    </div>
  </div>

  <!-- ═══ App scripts ═══ -->
  <script src="./fps.js"></script>
  <script src="./dynamics.js"></script>

  <!-- ═══ UI Wiring ═══ -->
  <script>
    (function(){
      // ── Fallback guards ──
      const API = [
        'startAnimation','startRecord','deletePath','setVelocitiesToZero',
        'changeAtomModel','changeInterval',
        'incrementEnergyLevel','decrementEnergyLevel',
        'incrementAngularMomentum','decrementAngularMomentum',
        'incrementM','decrementM',
        'changeAnsatz','toggleLamor','toggleThetaPhi',
        'lockNucleus','changeCountElectron','changeCountProton',
        'toggleRelaxation',
      ];
      API.forEach(name => {
        if (typeof window[name] !== 'function')
          window[name] = () => console.warn(name + "(): dynamics.js not loaded?");
      });

      // ── Helper: wire a click ──
      function on(id, fn) {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', fn);
      }

      // ── Helper: toggle button with aria-pressed ──
      function bindToggle(id, onToggle) {
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.addEventListener('click', () => {
          const next = btn.getAttribute('aria-pressed') !== 'true';
          btn.setAttribute('aria-pressed', String(next));
          btn.classList.toggle('active', next);
          onToggle(next);
        });
      }

      // ── Topbar buttons ──
      on('myButton',      () => window.startAnimation());
      on('PathButton',    () => window.startRecord());
      on('btnDeletePath', () => window.deletePath());
      on('btnResetV',     () => window.setVelocitiesToZero());

      document.getElementById('modelSelect')
        .addEventListener('change', e => window.changeAtomModel(e.target.value));

      // ── Quantum numbers: n, ℓ, m ──
      on('nUp',   () => window.incrementEnergyLevel());
      on('nDown', () => window.decrementEnergyLevel());
      on('lUp',   () => window.incrementAngularMomentum());
      on('lDown', () => window.decrementAngularMomentum());
      on('mUp',   () => window.incrementM());
      on('mDown', () => window.decrementM());

      // ── Particle counts ──
      on('eUp',   () => window.changeCountElectron(+1));
      on('eDown', () => window.changeCountElectron(-1));
      on('pUp',   () => window.changeCountProton(+1));
      on('pDown', () => window.changeCountProton(-1));

      // ── Toggle buttons ──
      bindToggle('btnAnsatz', next => {
        window.changeAnsatz();
        document.getElementById('ansatzRead').textContent = next ? 'an' : 'aus';
      });
      bindToggle('btnLarmor', next => {
        window.toggleLamor(next);
        document.getElementById('larmorRead').textContent = next ? 'an' : 'aus';
      });
      bindToggle('btnThetaPhi', next => {
        window.toggleThetaPhi(next);
        document.getElementById('thetaPhiRead').textContent = next ? 'an' : 'aus';
      });
      bindToggle('btnLock', next => {
        window.lockNucleus();
        document.getElementById('lockRead').textContent = next ? 'an' : 'aus';
      });
      bindToggle('btnRelax', next => {
        window.toggleRelaxation(next);
        document.getElementById('relaxRead').textContent = next ? 'an' : 'aus';
      });

      // ── Δt slider ──
      const dtSlider = document.getElementById('dtSlider');
      const dtValue  = document.getElementById('dtValue');
      function applyDt(val) {
        val = parseInt(val, 10);
        if (!Number.isFinite(val)) return;
        window.changeInterval(val);
        document.getElementById('dtRead').textContent = val + ' ms';
        dtValue.textContent = val + ' ms';
      }
      if (dtSlider) {
        dtSlider.addEventListener('input',  e => applyDt(e.target.value));
        dtSlider.addEventListener('change', e => applyDt(e.target.value));
      }

      // ── Theme toggle ──
      const root = document.documentElement;
      const themeToggle = document.getElementById('themeToggle');

      function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        if (themeToggle) themeToggle.textContent = theme === 'dark' ? '☾' : '☀︎';
        try { localStorage.setItem('ui-theme', theme); } catch {}
      }

      let saved = null;
      try { saved = localStorage.getItem('ui-theme'); } catch {}
      setTheme(saved === 'light' ? 'light' : 'dark');

      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          setTheme(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        });
      }

      // ── Quantum state label updater ──
      // Polls STATE.N / L / M every 500ms to update the |n,ℓ,m⟩ display
      const qLabel = document.getElementById('quantumStateLabel');
      if (qLabel) {
        setInterval(() => {
          const n = document.getElementById('nLvl')?.textContent || '?';
          const l = document.getElementById('lLvl')?.textContent || '?';
          const m = document.getElementById('mLvl')?.textContent || '?';
          qLabel.textContent = `|${n}, ${l}, ${m}⟩`;
        }, 500);
      }

      // ── Self-tests (dev console) ──
      (function tests(){
        function test(name, fn) {
          try { fn(); console.log('✅ ' + name); }
          catch(e) { console.error('❌ ' + name + ' →', e); }
        }
        test('A-Frame scene embedded',    () => { if (!document.querySelector('a-scene[embedded]')) throw 'missing'; });
        test('Core API functions present', () => {
          ['startAnimation','startRecord','deletePath','setVelocitiesToZero',
           'changeInterval','changeAnsatz','toggleLamor','lockNucleus',
           'tryTransition','toggleRelaxation','incrementM','decrementM']
            .forEach(fn => { if (typeof window[fn] !== 'function') throw fn + ' missing'; });
        });
        test('Topbar slider present',     () => { if (!document.getElementById('dtSlider')) throw 'missing'; });
        test('Quantum m controls present', () => { if (!document.getElementById('mUp')) throw 'missing'; });
      })();
    })();
  </script>
</body>
</html>